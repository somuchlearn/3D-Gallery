<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fine Art Print Konfigurator - 3D Preview</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            overflow: hidden;
            height: 100vh;
        }

        #container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        #canvas-container {
            width: 100%;
            height: 100%;
        }

        #controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.98);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 100;
            max-width: 340px;
            border: 1px solid #e0e0e0;
        }

        h1 {
            font-size: 22px;
            margin-bottom: 8px;
            color: #1a1a1a;
            font-weight: 700;
        }

        .subtitle {
            font-size: 13px;
            color: #666;
            margin-bottom: 20px;
            font-weight: 400;
        }

        .control-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input[type="file"] {
            display: none;
        }

        .file-upload-btn {
            display: block;
            width: 100%;
            padding: 14px;
            background: #000;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .file-upload-btn:hover {
            background: #333;
        }

        input[type="range"] {
            width: 100%;
            margin-top: 8px;
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #000;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #000;
            cursor: pointer;
            border: none;
        }

        .slider-value {
            display: inline-block;
            margin-left: 10px;
            color: #000;
            font-weight: 700;
            font-size: 13px;
        }

        select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            font-weight: 500;
        }

        button {
            width: 100%;
            padding: 14px;
            margin-top: 10px;
            background: #000;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button:hover {
            background: #333;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 18px;
            border-radius: 8px;
            color: #555;
            font-size: 13px;
            max-width: 280px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.98);
            padding: 40px 60px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            color: #000;
            display: none;
            z-index: 200;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .specs {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            font-size: 12px;
            color: #666;
        }

        .specs-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .specs-label {
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="canvas-container"></div>

        <div id="controls">
            <h1>Fine Art Print</h1>
            <div class="subtitle">Premium Gallery Frame</div>

            <div class="control-group">
                <label for="imageUpload">Ihr Kunstwerk</label>
                <input type="file" id="imageUpload" accept="image/*">
                <button class="file-upload-btn" onclick="document.getElementById('imageUpload').click()">
                    Bild hochladen
                </button>
            </div>

            <div class="control-group">
                <label for="frameWidth">
                    Rahmenbreite <span class="slider-value" id="frameWidthValue">3</span> cm
                </label>
                <input type="range" id="frameWidth" min="1" max="8" value="3" step="0.5">
            </div>

            <div class="control-group">
                <label for="frameDepth">
                    Rahmentiefe <span class="slider-value" id="frameDepthValue">3</span> cm
                </label>
                <input type="range" id="frameDepth" min="2" max="6" value="3" step="0.5">
            </div>

            <div class="control-group">
                <label for="printSize">Bildgröße</label>
                <select id="printSize">
                    <option value="0.5">30 x 40 cm</option>
                    <option value="0.75">50 x 70 cm</option>
                    <option value="1.0" selected>70 x 100 cm</option>
                    <option value="1.25">100 x 140 cm</option>
                    <option value="1.5">120 x 180 cm</option>
                </select>
            </div>

            <div class="control-group">
                <label for="glassEffect">Verglasung</label>
                <select id="glassEffect">
                    <option value="none">Ohne Glas</option>
                    <option value="glass" selected>Normalglas</option>
                    <option value="acrylic">Acrylglas</option>
                    <option value="museum">Museumsglas</option>
                </select>
            </div>

            <button id="exportBtn" disabled>3D Modell exportieren (GLB)</button>

            <div class="specs">
                <div class="specs-item">
                    <span class="specs-label">Material:</span>
                    <span>Aluminium-Dibond</span>
                </div>
                <div class="specs-item">
                    <span class="specs-label">Befestigung:</span>
                    <span>Alu-Schienen</span>
                </div>
                <div class="specs-item">
                    <span class="specs-label">Finish:</span>
                    <span>Matt</span>
                </div>
            </div>
        </div>

        <div id="info">
            <strong>Navigation:</strong><br>
            Linke Maustaste: Rotieren<br>
            Rechte Maustaste: Verschieben<br>
            Mausrad: Zoomen
        </div>

        <div class="loading" id="loading">Wird verarbeitet...</div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFExporter } from 'three/addons/exporters/GLTFExporter.js';

        let scene, camera, renderer, controls;
        let frameGroup = null;
        let currentTexture = null;

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf5f5f5);

            camera = new THREE.PerspectiveCamera(
                45,
                window.innerWidth / window.innerHeight,
                0.1,
                1000
            );
            camera.position.set(0, 0, 12);

            renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.5;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 5;
            controls.maxDistance = 30;
            controls.maxPolarAngle = Math.PI;

            // Gallery lighting - optimized for print visibility
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);

            const mainLight = new THREE.DirectionalLight(0xffffff, 1.5);
            mainLight.position.set(3, 5, 8);
            mainLight.castShadow = true;
            mainLight.shadow.mapSize.width = 2048;
            mainLight.shadow.mapSize.height = 2048;
            mainLight.shadow.camera.near = 0.5;
            mainLight.shadow.camera.far = 50;
            scene.add(mainLight);

            const fillLight = new THREE.DirectionalLight(0xffffff, 0.5);
            fillLight.position.set(-3, 2, 8);
            scene.add(fillLight);

            const backLight = new THREE.DirectionalLight(0xffffff, 0.3);
            backLight.position.set(0, 0, -5);
            scene.add(backLight);

            const spotLight = new THREE.SpotLight(0xffffff, 1.0);
            spotLight.position.set(0, 8, 6);
            spotLight.angle = Math.PI / 8;
            spotLight.penumbra = 0.4;
            scene.add(spotLight);

            window.addEventListener('resize', onWindowResize, false);

            document.getElementById('imageUpload').addEventListener('change', handleImageUpload);
            document.getElementById('frameWidth').addEventListener('input', updateFrame);
            document.getElementById('frameDepth').addEventListener('input', updateFrame);
            document.getElementById('printSize').addEventListener('input', updateFrame);
            document.getElementById('glassEffect').addEventListener('input', updateFrame);
            document.getElementById('exportBtn').addEventListener('click', exportModel);

            animate();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('loading').style.display = 'block';

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    createTextureFromImage(img);
                    createFramedPrint();
                    document.getElementById('loading').style.display = 'none';
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function createTextureFromImage(img) {
            const texture = new THREE.Texture(img);
            texture.needsUpdate = true;
            texture.colorSpace = THREE.SRGBColorSpace;
            currentTexture = texture;
        }

        function createFramedPrint() {
            if (!currentTexture) return;

            if (frameGroup) {
                scene.remove(frameGroup);
                frameGroup.traverse((child) => {
                    if (child.geometry) child.geometry.dispose();
                    if (child.material) {
                        if (Array.isArray(child.material)) {
                            child.material.forEach(m => m.dispose());
                        } else {
                            child.material.dispose();
                        }
                    }
                });
            }

            const frameWidth = parseFloat(document.getElementById('frameWidth').value) / 10;
            const frameDepth = parseFloat(document.getElementById('frameDepth').value) / 10;
            const printSizeMultiplier = parseFloat(document.getElementById('printSize').value);
            const glassType = document.getElementById('glassEffect').value;

            document.getElementById('frameWidthValue').textContent = (frameWidth * 10).toFixed(1);
            document.getElementById('frameDepthValue').textContent = (frameDepth * 10).toFixed(1);

            const img = currentTexture.image;
            const aspectRatio = img.width / img.height;

            const printHeight = 4 * printSizeMultiplier;
            const printWidth = printHeight * aspectRatio;

            frameGroup = new THREE.Group();

            // Print (Fine Art Paper)
            const printGeometry = new THREE.PlaneGeometry(printWidth, printHeight);
            const printMaterial = new THREE.MeshStandardMaterial({
                map: currentTexture,
                roughness: 0.6,
                metalness: 0.0,
                side: THREE.FrontSide,
                emissive: 0x000000,
                emissiveIntensity: 0,
            });
            const printMesh = new THREE.Mesh(printGeometry, printMaterial);
            printMesh.position.z = 0;
            frameGroup.add(printMesh);

            // Glass/Acrylic covering
            if (glassType !== 'none') {
                const glassGeometry = new THREE.PlaneGeometry(printWidth, printHeight);
                let transmission, glassRoughness, reflectivity;

                switch(glassType) {
                    case 'museum':
                        transmission = 0.98;
                        glassRoughness = 0.02;
                        reflectivity = 0.05;
                        break;
                    case 'acrylic':
                        transmission = 0.96;
                        glassRoughness = 0.05;
                        reflectivity = 0.08;
                        break;
                    default: // glass
                        transmission = 0.94;
                        glassRoughness = 0.08;
                        reflectivity = 0.1;
                }

                const glassMaterial = new THREE.MeshPhysicalMaterial({
                    color: 0xffffff,
                    transparent: true,
                    opacity: 1.0,
                    roughness: glassRoughness,
                    metalness: 0.0,
                    transmission: transmission,
                    thickness: 0.5,
                    ior: 1.5,
                    reflectivity: reflectivity,
                    side: THREE.FrontSide,
                });

                const glassMesh = new THREE.Mesh(glassGeometry, glassMaterial);
                glassMesh.position.z = 0.05;
                frameGroup.add(glassMesh);
            }

            // Black Frame (4 sides)
            const frameMaterial = new THREE.MeshStandardMaterial({
                color: 0x0a0a0a,
                roughness: 0.4,
                metalness: 0.1,
            });

            // Top frame
            const topFrame = new THREE.Mesh(
                new THREE.BoxGeometry(printWidth + frameWidth * 2, frameWidth, frameDepth),
                frameMaterial
            );
            topFrame.position.set(0, printHeight / 2 + frameWidth / 2, 0);
            topFrame.castShadow = true;
            frameGroup.add(topFrame);

            // Bottom frame
            const bottomFrame = new THREE.Mesh(
                new THREE.BoxGeometry(printWidth + frameWidth * 2, frameWidth, frameDepth),
                frameMaterial
            );
            bottomFrame.position.set(0, -printHeight / 2 - frameWidth / 2, 0);
            bottomFrame.castShadow = true;
            frameGroup.add(bottomFrame);

            // Left frame
            const leftFrame = new THREE.Mesh(
                new THREE.BoxGeometry(frameWidth, printHeight, frameDepth),
                frameMaterial
            );
            leftFrame.position.set(-printWidth / 2 - frameWidth / 2, 0, 0);
            leftFrame.castShadow = true;
            frameGroup.add(leftFrame);

            // Right frame
            const rightFrame = new THREE.Mesh(
                new THREE.BoxGeometry(frameWidth, printHeight, frameDepth),
                frameMaterial
            );
            rightFrame.position.set(printWidth / 2 + frameWidth / 2, 0, 0);
            rightFrame.castShadow = true;
            frameGroup.add(rightFrame);

            // Back panel (Dibond/backing)
            const backGeometry = new THREE.PlaneGeometry(printWidth, printHeight);
            const backMaterial = new THREE.MeshStandardMaterial({
                color: 0xd0d0d0,
                roughness: 0.7,
                metalness: 0.3,
                side: THREE.BackSide,
            });
            const backMesh = new THREE.Mesh(backGeometry, backMaterial);
            backMesh.position.z = -0.02;
            frameGroup.add(backMesh);

            // Aluminum hanging rails (2 horizontal rails)
            const railMaterial = new THREE.MeshStandardMaterial({
                color: 0xa0a0a0,
                roughness: 0.3,
                metalness: 0.8,
            });

            const railWidth = printWidth * 0.6;
            const railHeight = 0.08;
            const railDepth = 0.06;

            // Top rail
            const topRail = new THREE.Mesh(
                new THREE.BoxGeometry(railWidth, railHeight, railDepth),
                railMaterial
            );
            topRail.position.set(0, printHeight * 0.35, -0.05 - railDepth / 2);
            frameGroup.add(topRail);

            // Bottom rail
            const bottomRail = new THREE.Mesh(
                new THREE.BoxGeometry(railWidth, railHeight, railDepth),
                railMaterial
            );
            bottomRail.position.set(0, -printHeight * 0.35, -0.05 - railDepth / 2);
            frameGroup.add(bottomRail);

            // Rail mounting screws
            const screwMaterial = new THREE.MeshStandardMaterial({
                color: 0x505050,
                roughness: 0.4,
                metalness: 0.9,
            });

            const screwPositions = [
                [-railWidth / 3, printHeight * 0.35],
                [railWidth / 3, printHeight * 0.35],
                [-railWidth / 3, -printHeight * 0.35],
                [railWidth / 3, -printHeight * 0.35],
            ];

            screwPositions.forEach(([x, y]) => {
                const screw = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.02, 0.02, 0.01, 16),
                    screwMaterial
                );
                screw.position.set(x, y, -0.025);
                screw.rotation.x = Math.PI / 2;
                frameGroup.add(screw);
            });

            scene.add(frameGroup);
            document.getElementById('exportBtn').disabled = false;
        }

        function updateFrame() {
            if (currentTexture) createFramedPrint();
        }

        function exportModel() {
            if (!frameGroup) return;

            document.getElementById('loading').style.display = 'block';

            const exporter = new GLTFExporter();
            exporter.parse(
                frameGroup,
                function(result) {
                    const blob = new Blob([result], { type: 'application/octet-stream' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'fine-art-print-' + Date.now() + '.glb';
                    link.click();
                    URL.revokeObjectURL(url);
                    document.getElementById('loading').style.display = 'none';
                },
                function(error) {
                    console.error('Export error:', error);
                    alert('Fehler beim Exportieren des Modells');
                    document.getElementById('loading').style.display = 'none';
                },
                { binary: true }
            );
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();

            if (frameGroup) {
                frameGroup.rotation.y += 0.002;
            }

            renderer.render(scene, camera);
        }

        init();
    </script>
</body>
</html>
